<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>HTML Sandbox Stub</title>
  </head>

  <body>
    <script type="module">
      import * as OE from "./dist/index.js";
      import * as Distro from "./dist/distro.js";
      const params = new URLSearchParams(location.search);
      const pid = +params.get("pid");

      const q = OE.createListenerQueue();

      const channel = {
        send(msg) {
          window.top.postMessage({ msg, pid }, "*");
        },
        subscribe(
          cb,
          name = "anon." + Math.random().toString(36).substring(2, 8),
        ) {
          q.on(cb, name);
        },
        unsubscribe(name) {
          q.off(name);
        },
      };

      window.addEventListener("message", (evt) => {
        if (evt.data && evt.data.pid === pid && evt.data.msg) {
          q.push(evt.data.msg);
        }
      });

      try {
        window.openv = await Distro.connect(channel);
        window.env = { PID: pid };
        window.exit = (code) => {
          window.parent.postMessage({ code, pid }, "*");
        };
        window.print = console.log.bind(console);
        window.println = console.log.bind(console);
        window.eprint = console.error.bind(console);
        window.eprintln = console.error.bind(console);

        const args = await openv.api["party.openv.processes"].getArgs();
        const data = await openv.api["party.openv.fs"].readFile(args[0]);

        const { main } = await import(
          URL.createObjectURL(
            data.slice(0, data.size, "application/javascript"),
          )
        );

        await main?.(args);
      } catch (err) {
        console.error("Sandbox initialization failed:", err);
        window.parent.postMessage({ error: err.message, pid }, "*");
      }
    </script>
  </body>
</html>
